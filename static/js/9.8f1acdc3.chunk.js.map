{"version":3,"sources":["common/hooks.ts","DicomImporter/styles.ts","DicomImporter/components/Dropzone.tsx","DicomImporter/components/CircularProgressWithLabel.tsx","DicomImporter/DicomImporter.tsx"],"names":["useQueryParams","params","search","URLSearchParams","useLocation","Array","isArray","map","p","get","makeStylesWithIndex","styles","options","makeStyles","index","useUploaderStyles","root","background","boxSizing","header","fontSize","color","height","patientId","marginTop","dropzone","width","display","justifyContent","alignItems","borderRadius","rows","overflowY","row","margin","padding","dialogError","useProgressStyles","Dropzone","props","onDropFiles","disabled","classes","onDrop","useCallback","acceptedFiles","a","length","files","sort","b","name","useDropzone","multiple","accept","getRootProps","getInputProps","isDragActive","Box","className","CircularProgressWithLabel","position","CircularProgress","variant","top","left","bottom","right","Typography","component","style","Math","round","value","DicomImporter","useState","window","location","setPatientId","dialogMsg","setDialogMsg","fileStatusList","setFileStatusList","progress","setProgress","isProcessing","setIsProcessing","hasError","setHasError","updateProgress","progressEvent","percentCompleted","loaded","total","uploadPreProcess","statusList","filename","status","axios","method","url","API_URL","headers","err","uploadFiles","i","prev","newFiles","formData","FormData","append","data","onUploadProgress","message","uploadFinished","onStart","console","error","TextField","label","onChange","event","target","f","Dialog","open","onClose","DialogTitle","DialogContent","DialogContentText","id","DialogActions","Button","onClick"],"mappings":"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","file":"static/js/9.8f1acdc3.chunk.js","sourcesContent":["import { useLocation } from 'react-router-dom'\nimport { makeStyles, Theme as DefaultTheme } from '@material-ui/core'\nimport { Styles, WithStylesOptions } from '@material-ui/core/styles/withStyles'\n\nexport function useQueryParams<T extends string | string[]>(\n  params: T\n): T extends string ? string : string[] {\n  const search = new URLSearchParams(useLocation().search)\n\n  if (Array.isArray(params)) {\n    return (params as string[]).map((p) => search.get(p)!) as any\n  }\n\n  return search.get(params as string) as any\n}\n\n// https://stackoverflow.com/questions/62473898/material-ui-rendering-bugs-in-production-build/62646041#62646041\n// To avoid <style> injection order breaking our styles\n// We need to specify makeStyles options \"index\" to force our custom styles to be injected\n// at the end of the <head>\nexport function makeStylesWithIndex<\n  Theme = DefaultTheme,\n  Props extends object = {},\n  ClassKey extends string = string\n>(styles: Styles<Theme, Props, ClassKey>, options?: Omit<WithStylesOptions<Theme>, 'withTheme'>) {\n  return makeStyles(styles, { index: 1, ...options })\n}\n","import { makeStylesWithIndex } from 'common/hooks'\n\nexport const useUploaderStyles = makeStylesWithIndex({\n  root: {\n    background: 'rgb(48, 63, 71)',\n    boxSizing: 'border-box',\n  },\n  header: {\n    fontSize: '40px',\n    color: '#FFFFFF',\n    height: '100px',\n  },\n  patientId: {\n    color: '#FFFFFF',\n    '& label': {\n      fontSize: '24px !important',\n      color: '#FFFFFF !important',\n    },\n    '& input': {\n      marginTop: '8px',\n      color: '#FFFFFF !important',\n      fontSize: '36px !important',\n    },\n  },\n  dropzone: {\n    background: 'rgba(44, 50, 53, 1)',\n    height: '200px',\n    width: '100%',\n    display: 'flex',\n    justifyContent: 'center',\n    alignItems: 'center',\n    color: '#6EC4D0',\n    borderRadius: '16px',\n    '&.active': {\n      background: 'rgba(44, 50, 53, 0.5)',\n    },\n  },\n  rows: {\n    height: 'calc(100vh - 400px)',\n    overflowY: 'auto',\n  },\n  row: {\n    color: '#FFFFFF',\n    fontSize: '18px',\n    width: '80%',\n    borderRadius: '5px',\n    margin: '8px',\n    padding: '8px',\n    '&.bg': {\n      background: '#3B7B9C',\n    },\n  },\n  dialogError: {\n    color: 'red',\n  },\n})\n\nexport const useProgressStyles = makeStylesWithIndex({\n  root: {\n    color: '#6EC4D0',\n    '&.MuiTypography-caption': {\n      color: '#FFFFFF !important',\n    },\n  },\n})\n","import { Box } from '@material-ui/core'\n\nimport { useUploaderStyles } from '../styles'\nimport { useCallback } from 'react'\nimport { useDropzone } from 'react-dropzone'\n\ninterface Props {\n  disabled: boolean\n  onDropFiles: (files: File[]) => void\n}\n\nexport default function Dropzone(props: Props) {\n  const { onDropFiles, disabled } = props\n  const classes = useUploaderStyles()\n\n  const onDrop = useCallback(\n    // NOTE: Drop folder will miss file type \"application/type\"\n    async (acceptedFiles: File[]) => {\n      if (acceptedFiles.length === 0) {\n        return\n      }\n\n      const files = acceptedFiles.sort((a, b) => {\n        if (a.name > b.name) return 1\n        return a.name < b.name ? -1 : 0\n      })\n\n      onDropFiles(files)\n    },\n    [onDropFiles]\n  )\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop,\n    disabled,\n    multiple: true,\n    accept: ['.dcm', '.DCM'],\n  })\n\n  return (\n    <Box display=\"flex\" justifyContent=\"center\">\n      <div {...getRootProps()} className={`${classes.dropzone} ${isDragActive ? 'active' : ''}`}>\n        <input {...getInputProps()} />\n        <p>\n          {isDragActive\n            ? 'Drop the files here ...'\n            : disabled\n            ? 'Files processing, please wait for the current process finish'\n            : 'Drag some files here, or click to select files'}\n        </p>\n      </div>\n    </Box>\n  )\n}\n","import { CircularProgressProps, Box, CircularProgress, Typography } from '@material-ui/core'\nimport { useProgressStyles } from 'DicomImporter/styles'\n\nexport default function CircularProgressWithLabel(\n  props: CircularProgressProps & { value: number }\n) {\n  const classes = useProgressStyles()\n\n  return (\n    <Box position=\"relative\" display=\"inline-flex\">\n      <CircularProgress variant=\"determinate\" {...props} classes={{ root: classes.root }} />\n      <Box\n        top={0}\n        left={0}\n        bottom={0}\n        right={0}\n        position=\"absolute\"\n        display=\"flex\"\n        alignItems=\"center\"\n        justifyContent=\"center\"\n      >\n        <Typography variant=\"caption\" component=\"div\" style={{ color: '#FFFFFF' }}>{`${Math.round(\n          props.value\n        )}%`}</Typography>\n      </Box>\n    </Box>\n  )\n}\n","import {\n  Box,\n  Button,\n  Dialog,\n  DialogActions,\n  DialogContent,\n  DialogContentText,\n  DialogTitle,\n  TextField,\n} from '@material-ui/core'\nimport { useCallback, useState } from 'react'\nimport { useUploaderStyles } from './styles'\nimport Dropzone from './components/Dropzone'\nimport CircularProgressWithLabel from './components/CircularProgressWithLabel'\nimport axios from 'axios'\nimport { API_URL } from 'common/utils'\n\nexport default function DicomImporter() {\n  const classes = useUploaderStyles()\n  const [patientId, setPatientId] = useState(\n    new URLSearchParams(window.location.search).get('patient_id')\n  )\n  const [dialogMsg, setDialogMsg] = useState<string | null>(null)\n  const [fileStatusList, setFileStatusList] = useState<{ filename: string; status: string }[]>([])\n  const [progress, setProgress] = useState(0)\n  const [isProcessing, setIsProcessing] = useState(false)\n  const [hasError, setHasError] = useState(false)\n\n  const updateProgress = useCallback((progressEvent) => {\n    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total)\n    setProgress(percentCompleted)\n  }, [])\n\n  const uploadPreProcess = useCallback(\n    (files: File[]) => {\n      const statusList = files.map((a: File) => ({\n        filename: a.name,\n        status: 'pending',\n      }))\n      setFileStatusList(statusList)\n      setIsProcessing(true)\n      setHasError(false)\n\n      try {\n        axios({\n          method: 'post',\n          url: `${API_URL}/importer/${patientId}/start`,\n          headers: { 'Content-Type': 'application/json' },\n        })\n      } catch (err) {\n        setDialogMsg('Failed to start the upload process, please try again.')\n        throw err\n      }\n      return\n    },\n    [patientId]\n  )\n\n  const uploadFiles = useCallback(\n    async (acceptedFiles: File[]) => {\n      for (let i = 0; i < acceptedFiles.length; i++) {\n        setFileStatusList((prev) => {\n          const newFiles = [...prev]\n          if (i > 0) {\n            newFiles[i - 1].status = 'completed'\n          }\n          newFiles[i].status = 'uploading'\n          return newFiles\n        })\n\n        const formData = new FormData()\n        formData.append('dicom', acceptedFiles[i])\n\n        try {\n          await axios({\n            method: 'post',\n            url: `${API_URL}/importer/${patientId}/dicom`,\n            data: formData,\n            headers: { 'Content-Type': 'multipart/form-data' },\n            onUploadProgress: updateProgress,\n          })\n        } catch (err) {\n          setDialogMsg(`Upload file ${acceptedFiles[i].name} failed. ${err.message}`)\n          // axios will update the progress to 100 when error occurred\n          // we need to reset it to avoid misunderstanding\n          setProgress(0)\n          throw err\n        }\n      }\n\n      setFileStatusList((prev) => {\n        const newFiles = [...prev]\n        newFiles[prev.length - 1].status = 'completed'\n        return newFiles\n      })\n    },\n    [updateProgress, patientId]\n  )\n\n  const uploadFinished = useCallback(async () => {\n    try {\n      await axios({\n        method: 'post',\n        url: `${API_URL}/importer/${patientId}/end`,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    } catch (err) {\n      setDialogMsg('Unfortunately, the upload process ended with error, please try again.')\n      throw err\n    }\n    setIsProcessing(false)\n    setDialogMsg('You have uploaded all the files.')\n  }, [patientId])\n\n  const onStart = useCallback(\n    async (files: File[]) => {\n      try {\n        await uploadPreProcess(files)\n        await uploadFiles(files)\n        await uploadFinished()\n      } catch (err) {\n        setHasError(true)\n        console.error(err)\n      }\n\n      setIsProcessing(false)\n    },\n    [uploadPreProcess, uploadFiles, uploadFinished]\n  )\n\n  return (\n    <Box height=\"100vh\" p=\"40px\" className={classes.root}>\n      <header className={classes.header}>\n        <TextField\n          label=\"Patient\"\n          value={patientId}\n          classes={{ root: classes.patientId }}\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) =>\n            setPatientId(event.target.value)\n          }\n          error={!patientId}\n        />\n      </header>\n      <Dropzone onDropFiles={onStart} disabled={!patientId || isProcessing} />\n      <section className={classes.rows}>\n        <div className={classes.row}>Filename - Status</div>\n        {fileStatusList.map((f) => {\n          return (\n            <Box\n              key={f.filename}\n              className={`${classes.row} bg`}\n              display=\"flex\"\n              justifyContent=\"space-between\"\n              alignItems=\"center\"\n            >\n              <span>\n                {f.filename} - {f.status}{' '}\n              </span>\n              <span>\n                {f.status === 'uploading' && <CircularProgressWithLabel value={progress} />}\n              </span>\n            </Box>\n          )\n        })}\n      </section>\n      {dialogMsg && (\n        <Dialog open={true} onClose={() => setDialogMsg(null)}>\n          <DialogTitle className={hasError ? classes.dialogError : ''}>\n            {' '}\n            {hasError ? 'Oops!' : 'Congratulation!'}\n          </DialogTitle>\n          <DialogContent>\n            <DialogContentText id=\"alert-dialog-description\">{dialogMsg}</DialogContentText>\n          </DialogContent>\n          <DialogActions>\n            <Button onClick={() => setDialogMsg(null)} color=\"primary\">\n              OK\n            </Button>\n          </DialogActions>\n        </Dialog>\n      )}\n    </Box>\n  )\n}\n"],"sourceRoot":""}